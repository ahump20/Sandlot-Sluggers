<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MMI Dashboard - Blaze Sports Intel</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
      color: #fff;
      min-height: 100vh;
      padding: 20px;
    }
    
    .container {
      max-width: 1400px;
      margin: 0 auto;
    }
    
    header {
      text-align: center;
      margin-bottom: 30px;
    }
    
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
    }
    
    .subtitle {
      font-size: 1.1rem;
      opacity: 0.9;
      margin-bottom: 20px;
    }
    
    .controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 20px;
      margin-bottom: 30px;
      display: flex;
      gap: 15px;
      flex-wrap: wrap;
      align-items: center;
    }
    
    .control-group {
      display: flex;
      flex-direction: column;
      gap: 5px;
    }
    
    label {
      font-size: 0.9rem;
      opacity: 0.8;
    }
    
    select, button {
      padding: 10px 15px;
      border: none;
      border-radius: 6px;
      font-size: 1rem;
      cursor: pointer;
      background: rgba(255, 255, 255, 0.2);
      color: #fff;
      transition: all 0.3s;
    }
    
    select:hover, button:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: translateY(-2px);
    }
    
    select option {
      background: #2a5298;
      color: #fff;
    }
    
    .main-display {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }
    
    @media (max-width: 768px) {
      .main-display {
        grid-template-columns: 1fr;
      }
    }
    
    .card {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(10px);
      border-radius: 12px;
      padding: 25px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.2);
    }
    
    .mmi-display {
      text-align: center;
    }
    
    .mmi-score {
      font-size: 5rem;
      font-weight: bold;
      margin: 20px 0;
      text-shadow: 0 0 20px rgba(255,255,255,0.5);
    }
    
    .mmi-category {
      font-size: 1.5rem;
      margin-bottom: 10px;
      padding: 10px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.1);
    }
    
    .category-elite {
      background: rgba(255, 0, 0, 0.3);
      color: #ff6b6b;
    }
    
    .category-high {
      background: rgba(255, 165, 0, 0.3);
      color: #ffa500;
    }
    
    .category-moderate {
      background: rgba(255, 255, 0, 0.3);
      color: #ffd700;
    }
    
    .category-routine {
      background: rgba(0, 255, 0, 0.3);
      color: #90ee90;
    }
    
    .components {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }
    
    .component {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      border-left: 4px solid #4a90e2;
    }
    
    .component-label {
      font-size: 0.9rem;
      opacity: 0.8;
      margin-bottom: 5px;
    }
    
    .component-value {
      font-size: 1.5rem;
      font-weight: bold;
    }
    
    .component-weight {
      font-size: 0.8rem;
      opacity: 0.6;
      margin-top: 5px;
    }
    
    .leaderboard {
      margin-top: 30px;
    }
    
    .leaderboard h2 {
      margin-bottom: 20px;
      font-size: 1.8rem;
    }
    
    .leaderboard-item {
      background: rgba(255, 255, 255, 0.05);
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      transition: all 0.3s;
    }
    
    .leaderboard-item:hover {
      background: rgba(255, 255, 255, 0.1);
      transform: translateX(5px);
    }
    
    .leaderboard-rank {
      font-size: 1.5rem;
      font-weight: bold;
      color: #4a90e2;
      min-width: 40px;
    }
    
    .leaderboard-info {
      flex: 1;
      margin-left: 15px;
    }
    
    .leaderboard-mmi {
      font-size: 1.8rem;
      font-weight: bold;
      color: #ffd700;
    }
    
    .status {
      text-align: center;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    
    .status.loading {
      background: rgba(255, 255, 0, 0.2);
      color: #ffd700;
    }
    
    .status.error {
      background: rgba(255, 0, 0, 0.2);
      color: #ff6b6b;
    }
    
    .status.success {
      background: rgba(0, 255, 0, 0.2);
      color: #90ee90;
    }
    
    .refresh-indicator {
      text-align: center;
      margin-top: 20px;
      opacity: 0.7;
      font-size: 0.9rem;
    }
    
    .game-state {
      margin-top: 20px;
      padding-top: 20px;
      border-top: 1px solid rgba(255, 255, 255, 0.2);
    }
    
    .game-state-item {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 0.9rem;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>MMI Dashboard</h1>
      <p class="subtitle">Moment Mentality Index - Real-time Pressure Analysis</p>
    </header>
    
    <div class="controls">
      <div class="control-group">
        <label for="gameSelect">Select Game</label>
        <select id="gameSelect">
          <option value="">Loading games...</option>
        </select>
      </div>
      <div class="control-group">
        <label for="timeframeSelect">Top Moments</label>
        <select id="timeframeSelect">
          <option value="7">Last 7 Days</option>
          <option value="30">Last 30 Days</option>
          <option value="90">Last 90 Days</option>
        </select>
      </div>
      <button id="refreshBtn">Refresh Now</button>
      <button id="topMomentsBtn">View Top Moments</button>
    </div>
    
    <div id="status" class="status" style="display: none;"></div>
    
    <div class="main-display" id="mainDisplay" style="display: none;">
      <div class="card mmi-display">
        <h2>Current MMI</h2>
        <div class="mmi-score" id="mmiScore">--</div>
        <div class="mmi-category" id="mmiCategory">--</div>
        <div class="game-state" id="gameState"></div>
      </div>
      
      <div class="card">
        <h2>Component Breakdown</h2>
        <div class="components" id="components">
          <!-- Components will be inserted here -->
        </div>
      </div>
    </div>
    
    <div class="card leaderboard" id="leaderboard" style="display: none;">
      <h2>Top MMI Moments</h2>
      <div id="leaderboardList"></div>
    </div>
    
    <div class="refresh-indicator" id="refreshIndicator"></div>
  </div>
  
  <script>
    const API_BASE = 'https://blazesportsintel.com/mmi';
    let currentGameId = null;
    let refreshInterval = null;
    
    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      loadTodayGames();
      setupEventListeners();
      startAutoRefresh();
    });
    
    function setupEventListeners() {
      document.getElementById('gameSelect').addEventListener('change', (e) => {
        currentGameId = e.target.value;
        if (currentGameId) {
          loadMMI(currentGameId);
        }
      });
      
      document.getElementById('refreshBtn').addEventListener('click', () => {
        if (currentGameId) {
          loadMMI(currentGameId);
        } else {
          showStatus('Please select a game first', 'error');
        }
      });
      
      document.getElementById('topMomentsBtn').addEventListener('click', () => {
        loadTopMoments();
      });
      
      document.getElementById('timeframeSelect').addEventListener('change', () => {
        if (document.getElementById('leaderboard').style.display !== 'none') {
          loadTopMoments();
        }
      });
    }
    
    async function loadTodayGames() {
      try {
        const response = await fetch(`${API_BASE}/games/today`);
        const data = await response.json();
        
        const select = document.getElementById('gameSelect');
        select.innerHTML = '<option value="">Select a game...</option>';
        
        if (data.games && data.games.length > 0) {
          data.games.forEach(game => {
            const option = document.createElement('option');
            option.value = game.gamePk;
            option.textContent = `${game.teams.away.team.name} @ ${game.teams.home.team.name} - ${game.gameDate.split('T')[0]}`;
            select.appendChild(option);
          });
        } else {
          select.innerHTML = '<option value="">No games today</option>';
        }
      } catch (error) {
        console.error('Error loading games:', error);
        showStatus('Error loading games. Using mock data.', 'error');
        // Fallback to mock data for testing
        const select = document.getElementById('gameSelect');
        select.innerHTML = `
          <option value="717715">Mock Game: Yankees @ Red Sox</option>
        `;
      }
    }
    
    async function loadMMI(gameId) {
      showStatus('Loading MMI...', 'loading');
      
      try {
        const response = await fetch(`${API_BASE}/${gameId}`);
        if (!response.ok) {
          throw new Error(`HTTP ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.error) {
          throw new Error(data.error);
        }
        
        displayMMI(data);
        showStatus('MMI loaded successfully', 'success');
        setTimeout(() => {
          document.getElementById('status').style.display = 'none';
        }, 2000);
      } catch (error) {
        console.error('Error loading MMI:', error);
        showStatus(`Error: ${error.message}`, 'error');
        
        // Show mock data for demonstration
        displayMMI({
          gameId: gameId || '717715',
          playerId: '12345',
          mmi: 67.2,
          timestamp: new Date().toISOString(),
          components: {
            leverageIndex: 2.3,
            pressure: 75.0,
            fatigue: 65.0,
            execution: 70.0,
            bio: 55.0
          },
          gameState: {
            inning: 9,
            halfInning: 'bottom',
            outs: 2,
            bases: 'loaded',
            scoreDiff: -1,
            count: '3-2'
          }
        });
      }
    }
    
    function displayMMI(data) {
      document.getElementById('mainDisplay').style.display = 'grid';
      
      // Display MMI score
      const mmi = Math.round(data.mmi * 10) / 10;
      document.getElementById('mmiScore').textContent = mmi;
      
      // Category
      const category = getMMICategory(mmi);
      const categoryEl = document.getElementById('mmiCategory');
      categoryEl.textContent = category.label;
      categoryEl.className = `mmi-category category-${category.class}`;
      
      // Components
      const componentsEl = document.getElementById('components');
      componentsEl.innerHTML = '';
      
      const componentData = [
        { name: 'Leverage Index', value: data.components.leverageIndex, weight: '35%' },
        { name: 'Pressure', value: data.components.pressure, weight: '20%' },
        { name: 'Fatigue', value: data.components.fatigue, weight: '20%' },
        { name: 'Execution', value: data.components.execution, weight: '15%' },
        { name: 'Bio', value: data.components.bio, weight: '10%' }
      ];
      
      componentData.forEach(comp => {
        const div = document.createElement('div');
        div.className = 'component';
        div.innerHTML = `
          <div class="component-label">${comp.name}</div>
          <div class="component-value">${Math.round(comp.value * 10) / 10}</div>
          <div class="component-weight">Weight: ${comp.weight}</div>
        `;
        componentsEl.appendChild(div);
      });
      
      // Game state
      if (data.gameState) {
        const gameStateEl = document.getElementById('gameState');
        gameStateEl.innerHTML = `
          <div class="game-state-item">
            <span>Inning:</span>
            <span>${data.gameState.inning}${data.gameState.halfInning === 'top' ? '↑' : '↓'}</span>
          </div>
          <div class="game-state-item">
            <span>Outs:</span>
            <span>${data.gameState.outs}</span>
          </div>
          <div class="game-state-item">
            <span>Bases:</span>
            <span>${data.gameState.bases || 'empty'}</span>
          </div>
          <div class="game-state-item">
            <span>Count:</span>
            <span>${data.gameState.count || '0-0'}</span>
          </div>
          <div class="game-state-item">
            <span>Score Diff:</span>
            <span>${data.gameState.scoreDiff || 0}</span>
          </div>
        `;
      }
    }
    
    function getMMICategory(mmi) {
      if (mmi >= 70) {
        return { label: 'Elite Pressure', class: 'elite' };
      } else if (mmi >= 55) {
        return { label: 'High Difficulty', class: 'high' };
      } else if (mmi >= 40) {
        return { label: 'Moderate', class: 'moderate' };
      } else {
        return { label: 'Routine', class: 'routine' };
      }
    }
    
    async function loadTopMoments() {
      const timeframe = document.getElementById('timeframeSelect').value;
      
      try {
        const response = await fetch(`${API_BASE}/top?limit=10&timeframe=${timeframe}`);
        const data = await response.json();
        
        const leaderboardEl = document.getElementById('leaderboard');
        const listEl = document.getElementById('leaderboardList');
        
        leaderboardEl.style.display = 'block';
        listEl.innerHTML = '';
        
        if (data.topMoments && data.topMoments.length > 0) {
          data.topMoments.forEach((moment, index) => {
            const div = document.createElement('div');
            div.className = 'leaderboard-item';
            div.innerHTML = `
              <div class="leaderboard-rank">#${index + 1}</div>
              <div class="leaderboard-info">
                <div>Game: ${moment.game_id} | Player: ${moment.player_id}</div>
                <div style="font-size: 0.8rem; opacity: 0.7;">
                  ${new Date(moment.created_at).toLocaleString()}
                </div>
              </div>
              <div class="leaderboard-mmi">${Math.round(moment.mmi_score * 10) / 10}</div>
            `;
            listEl.appendChild(div);
          });
        } else {
          listEl.innerHTML = '<p>No moments found for this timeframe.</p>';
        }
      } catch (error) {
        console.error('Error loading top moments:', error);
        showStatus('Error loading top moments', 'error');
      }
    }
    
    function showStatus(message, type) {
      const statusEl = document.getElementById('status');
      statusEl.textContent = message;
      statusEl.className = `status ${type}`;
      statusEl.style.display = 'block';
    }
    
    function startAutoRefresh() {
      // Refresh every 5 seconds if a game is selected
      refreshInterval = setInterval(() => {
        if (currentGameId) {
          loadMMI(currentGameId);
        }
        updateRefreshIndicator();
      }, 5000);
      
      updateRefreshIndicator();
    }
    
    function updateRefreshIndicator() {
      const indicator = document.getElementById('refreshIndicator');
      const now = new Date();
      indicator.textContent = `Last updated: ${now.toLocaleTimeString()} | Auto-refresh: 5s`;
    }
  </script>
</body>
</html>
